//To create a windows application
#include <windows.h>
//Main game engine
#include "GGE/Engine/GGEMain.h"
//Game resources
#include "GGE/Resource/GRE.h"
//Resource file to load
#include "GGE/Resource/ResourceFile.h"
//To use graphics (bg)
#include "GGE/Engine/Graphics.h"
//To use pointers
#include "GGE/Engine/Pointer.h"
//To create layers
#include "GGE/Engine/GraphicLayers.h"
//To use widgets
#include "GGE/Widgets/WidgetRegistry.h"

//Local resources (for icon)
#include "Resource.h"

//required namespace
using namespace gge;
using namespace gorgonwidgets;
using namespace gre;

//Our resource file,
ResourceFile *widgets;


//constant definitions
#define WIDTH			513
#define HEIGHT			600
#define WIDGET_FILE		"Wooden.wgt"
#define VERSION			1
#define REVISION		0

//Game stages
enum GameStages {
	Ending=0,
	Running
};

//Current stage
GameStages stage=Running;

//Quit function
void Quit() {
	stage=Ending;
}

//Window destroyed event
void window_destroyed(empty_event_params parameters, Empty &object, Any data, string eventname) {
	Quit();
}

//Windows application entry point
int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR     lpCmdLine, int       nCmdShow) {
	//Create game engine
	main=new GGEMain("tetris", (InstanceHandle)hInstance,WIDTH,HEIGHT);

	//Build application title (window title)
	stringstream title;
	title<<"Tetris Version "<<VERSION<<"."<<REVISION;
	
	//Initialize every module that is supported
	main->InitializeAll(title.str().c_str(), (IconHandle)LoadIcon(hInstance, (LPCTSTR)IDI_ICON1), 0, 0);
	//Triggers window_destroyed when it is closed, which quits the game
	WindowDestroyedEvent.Register(window_destroyed);

	//creates a new resource file
	widgets=new ResourceFile();
	//registers widget loaders
	RegisterWidgetLoaders(widgets);

	//Loads our widget file
	widgets->LoadFile(WIDGET_FILE);
	//Prepares everything
	widgets->Prepare(main);
	
	//Locates required widgets
	WidgetRegistry.DiscoverWidgets(widgets);
	
	//Sets and shows pointer
	SetPointer(PointerTypes::Arrow);
	ShowPointer();

	//Create and adjust background
	Basic2DLayer Background(0,0, main->W,main->H);
	main->Add(&Background, 10);
	WidgetRegistry.background->DrawTiled(&Background, 0,0, main->W, main->H);


	//Game loop
	while(stage==Running) {
		main->BeforeGameLoop();


		main->BeforeRender();
		main->Render();
		main->AfterRender();
	}

	return 0;
}
